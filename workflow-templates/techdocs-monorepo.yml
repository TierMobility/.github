name: Render & Publish TechDocs from monorepo

on:
  push:
    # runs only when TechDocs related files are updated.
    branches: [$default-branch]
    paths:
      - "packages/**/docs/**"
      - "packages/**/mkdocs.yaml"
      - "packages/**/mkdocs.yml"

jobs:
  setup:
    # discover catalog info files
    uses: TierMobility/techdocs-workflows/.github/workflows/discover-catalog-locations.yml@main
    with:
      package_dir: packages/
      entity_filename: catalog-info.yaml
  techdocs:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.entity_locations) }}
    steps:
      # extract component information from the catalog info file
      - id: extract-entity-info
        uses: TierMobility/techdocs-workflows/.github/workflows/extract-entity-info.yml@main
        with:
          path: ${{ matrix.path }}
          entity_kind: Component
      # render and publish techdocs
      - id: render-publish-s3
        uses: TierMobility/techdocs-workflows/.github/workflows/render-publish-s3.yml@main
        with:
          entity_name: ${{ steps.extract-entity-info.outputs.entity_name }}
          entity_namespace: ${{ steps.extract-entity-info.outputs.entity_namespace }}
          entity_kind: ${{ steps.extract-entity-info.outputs.entity_kind }}
        secrets: inherit
